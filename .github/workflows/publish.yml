name: CI/CD Pipeline

on:
  push:
    branches: ['main']
  pull_request:
    branches: ['main']
  release:
    types: [published]

jobs:
  # [í…ŒìŠ¤íŠ¸ ì‘ì—…]ì€ ê·¸ëŒ€ë¡œ ìœ ì§€
  test-and-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
      - run: npm install --legacy-peer-deps
      - run: npm test
      - run: npm run prepare

  # [ë°°í¬ ì‘ì—…] - ì—¬ê¸°ê°€ ë°”ë€ë‹ˆë‹¤!
  publish-package:
    needs: test-and-build
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    permissions:
        id-token: write # Required for OIDC
        contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm install --legacy-peer-deps

      # ğŸ‘‡ [í•µì‹¬] íƒœê·¸ ì´ë¦„(v1.0.0)ì—ì„œ 'v'ë¥¼ ë–¼ê³  ë²„ì „ ìˆ«ìë§Œ ì¶”ì¶œ
      - name: ë¦´ë¦¬ì¦ˆ ë²„ì „ ì¶”ì¶œ
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV

      # ğŸ‘‡ [í•µì‹¬] ì¶”ì¶œí•œ ë²„ì „ìœ¼ë¡œ package.json ê°•ì œ ìˆ˜ì • (git íƒœê·¸ ìƒì„± ì—†ì´ íŒŒì¼ë§Œ ìˆ˜ì •)
      - name: package.json ë²„ì „ ì—…ë°ì´íŠ¸
        # ğŸ‘‡ ë§¨ ë’¤ì— --allow-same-version ì¶”ê°€
        run: npm version ${{ env.VERSION }} --no-git-tag-version --allow-same-version

      - name: ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¹Œë“œ (ì—…ë°ì´íŠ¸ëœ ë²„ì „ìœ¼ë¡œ ë¹Œë“œë¨)
        run: npm run prepare

      - name: NPM ë°°í¬
        run: npm publish --provenance